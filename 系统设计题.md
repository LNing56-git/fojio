> 抱佛脚一时爽，一直抱佛脚一直爽！这篇文章总结常见的系统设计问题~因为是抱佛脚，所以结构上没有什么逻辑...
>
> 参考链接：[Waking-Up](https://github.com/wolverinn/Waking-Up)  [CycNotes](https://github.com/CyC2018/CS-Notes)  [牛客网](https://www.nowcoder.com/) 

1.某个用户可以关注其他用户，某用户也可以被其他用户关注，请问在 MySQL 中如何设计表结构来存储这些关注和被关注信息？需求是可以查询出某用户的所有关注以及所有粉丝？
    - 只需要两个字段，from_id 和 to_id：某个用户uid1 ，关注了另一个用户 uid2，那么 from_id 就设置为 uid1，to_id 设置为 uid2；索引的话，主键有主键索引，剩下的字段不适合建索引，因为字段重复太多

2.弱网环境下的网络性能调优
(1)请求速度的优化
    - 直接使用 IP 地址，去除 DNS 解析步骤；或者减少url中的域名数（因为每段域名对应一个DNS），使用一个服务器用来还原域名
    - 不要每次请求都重新建立连接，复用连接或一直使用同一条连接(长连接)
        *keep-alive（http 1.1默认开启）：请求完成后不立即释放连接，而是放入连接池中，若这时有另一个请求要发出，请求的域名和端口是一样的，就直接拿出连接池中的连接进行发送和接收数据
            ~缺点：keep-alive 的连接一次只能发送接收一个请求，在上一个请求处理完成之前，无法接受新的请求
        *多路复用（http2提出）：复用的这条连接支持同时处理多条请求，所有请求都可以并发在这条连接上进行
            ~原理：它把在连接里传输的数据都封装成一个个stream，每个stream都有标识，stream的发送和接收可以是乱序的，不依赖顺序，也就不会有阻塞的问题，接收端可以根据stream的标识去区分属于哪个请求，再进行数据拼接，得到最终数据
    - 压缩数据，减小传输的数据大小
        *使用protobuf而不是json：json 是字符串，protobuf 是二进制，即使用各种压缩算法压缩后，protobuf 仍会比 json 小；数据量上 protobuf 有优势，序列化速度 protobuf 也有一些优势
        *HTTP2 里对 HTTP 协议头也进行了压缩：固定的字段如 method 可以用静态字典，不固定但多个请求重复的字段例如 cookie 用动态字典
(2)提高请求成功率
    - (1)优化请求速度
    - 加快对超时的判断，减少等待时间，尽早重试

3.网页加载慢可能是什么问题，怎么优化
- 弱网环境，可以使用http2
    *多路复用
    *压缩http协议头
    *允许服务器在客户端未请求时推送数据给客户端；这样客户端可以直接从本地加载这些资源，不用再通过网络
- 服务器性能有限，可以优化服务器配置
    *加大服务器的带宽（给定时间内可以传输的数据量）、内存、CPU（CPU影响运算能力，内存影响同时处理的数据能力，带宽影响同时接入的人数）
- 服务器遭到恶意攻击，有人大量发请求，可以禁止一些访问
- 数据库瓶颈
    *慢查询多：优化SQL语句或者加一些索引
    *db响应慢：加redis做缓存
- 网页体积过大，可以进行压缩
    *采用外部文件的形式使用css和js。许多情况下造成网页臃肿的另一个原因是网页中插入了太多的css和js
- 有的静态资源特别大，拖累了整个网页的加载，可以让CDN缓存这部分的资源
    *CDN的工作原理：
        ~首先我们在地址栏键入一个网址，浏览器发现本地没有关于这个网址的 DNS 缓存，所以向网站的 DNS 服务器发起请求。
        ~网站的 DNS 服务器设置了 CNAME，指向了某个 CDN 服务器，也就是我们常见的阿里云、腾讯云、Cloudflare 之类的，去请求 CDN 中的智能 DNS 均衡负载系统。
        ~均衡负载系统解析域名，把对用户响应最快的节点返回给用户，然后用户向该节点发出请求。
        ~如果是第一次访问该内容，CDN 服务器会向源站请求数据并缓存，否则的话，直接在缓存节点中找到该数据，将请求结果发给用户
- 本地机器内存不够

4.设计一个秒杀程序及避免超卖问题
----前端----
(1)禁止重复提交
    - 秒杀开始之后，可以对用户点击后响应前按钮置灰
(2)限流
    - 一单秒杀开始，实际秒杀成功的用户只是库存的数量，在库存没有之后，将前端的秒杀入口关闭
----后端----
(1)缓存
    - 上午十点开始秒杀，很多用户可能在九点五十左右就开始访问自己心仪的秒杀商品
    - 参加秒杀系统的商品是事先可知的，可以将参加秒杀的商品信息事先缓存到redis等缓存系统中
    - 将产品的业务唯一字段作为key，库存作为value
(2)避免刷单行为
    - 有的用户为了抢到商品可能利用第三插件，去频繁的访问接口
    - 预测接口的实际访问频率，对同一个用户做频率限制，如某个抢购入口，可以设置一个用户一分钟不能访问超过60次
    - 可以通过redis实现：以某个接口+用户唯一性标准为key，以访问次数为value，设置过期时间为1min
    - 用户每次访问接口，可以先判断该值有没有达到预设的访问频率限制的值，如果达到了，就告诉用户，你的访问太过频繁，请多长时间后再试，或者要求用户输入验证码
    - 一个用户可能当初注册了很多的账号，平时不用，专门用来参加秒杀活动，这样其实也会造成系统压力。解决方式和上述差不多，只是对ip做限制
(3)缓解单机压力
    - 服务的可扩展，可以水平添加机器将用户请求分担到不同的机器上去
    - 数据库可扩展，支持分库分表，对于用户的请求，映射到不同的数据库，减少单台数据库的压力
(4)削峰
    - 在抢购一开始会有很高的瞬间峰值
    - 通过消息队列把瞬间的高流量变成一段时间平稳的流量
----总流程----
(1)秒杀开始前
    - 将参加秒杀的商品信息事先缓存到redis中，将产品的业务唯一字段作为key，库存作为value
    - 启动一个后台线程，阻塞等待商品库存售完的通知
(2)秒杀时
    - 用户点击后响应前按钮置灰，禁止重复提交
    - 判断用户是否超过访问频率限制，是则返回访问频繁信息或要求输入验证码
    - 根据商品的key查询当前库存
        *如果大于零，判断当前的set集合中是否有该用户ID，如果没有，减库存（通过redis的事务和watch命令，事务保证这些操作都执行或都不执行；watch是CAS乐观锁，保证库存的一致性，重试n次，n次返回均未成功，则接口返回失败）并且将用户的ID放入集合中；如果集合中已经存在该用户id，则不做任何处理，直接处理下一个请求
        *如果==0，返回已售空信息
    - 商品售空则唤醒一开始启动的后台进程，它获取set集合中的用户信息，异步处理需要操作的购买等后续操作

5.抖音一个地区的许多用户无法访问网站的原因
- 该地区遭遇dns劫持
- 该地区网络异常
- 该地区ip被网站禁止访问了
- 该地区的核心路由器或交换机配置问题

6.海量数据问题
(1)频率topK
    - 分治+Trie树/hash+小顶堆
    - 先将数据集按照Hash方法分解成多个小数据集
    - 使用Trie树或者Hash统计每个小数据集中的query词频
        *第一次扫描，取首字节，尾字节，中间随便两字节作为Hash Code，插入到hash table中，记录其地址和信息长度和重复次数
        *第二次hash table的处理：同Hash Code且等长就疑似相同，比较一下
    - 用小顶堆/快排求出每个数据集中出现频率最高的前K个数，最后在所有top K中求出最终的top K
(2)大小topK
    - 先通过Hash法，把这1亿个数字去重复
    - 将数据集按照Hash方法分解成多个小数据集，用小顶堆/快排求出每个数据集的topK
    - 最后在所有top K中求出最终的top K
(3)1亿个正整数,范围是0-42亿。求出现的数字
    - 开一个42亿大小的位图
    - 遍历整个数据集，比如遍历到8，就把bitmap[8]置为1
(4)10G 个整数,乱序排列,要求找出中位数
http://blog.sina.com.cn/s/blog_8e9c63c70101f5pl.html

7.一个1G文件，可用内存100M的排序方法
- 将文件分成10个100M，并依次载入内存中进行排序，最后结果存入硬盘，得到10个分别排好序的文件
- 从每个文件载入9M的数据到输入缓存区，输出缓存区大小为10M
- 类似k路归并的思路，排好的放到输出缓存区，输出缓存区满了就写入磁盘

8.大数据下的浏览量、点赞数等指标的更新
- 用redis存放video的访问增量，key可以为“video_count_inc”+videoId
- 在访问video详情时redis访问增量+1，
- 定时任务读取redis中的增量更新到视频中，更新完后redis要减去这个增量（如果增量为0则删除这个key）；
- 查询视频时其阅读量要加上redis中的增量

9.300G的大文件，前部分是时间戳，后部分是日志内容，如何搜寻某段时间的日志内容
- 模拟B+树或OS中的多级页表，或者模拟redis中的跳跃表

10.设计分布式日志系统
- Scribe通过thrift从各种数据源上收集数据，放到一个共享消息队列上，后端的中央存储系统上消费这些消息。当中央存储系统出现故障时，scribe可以暂时把日志写到本地文件中，待中央存储系统恢复性能后，scribe把本地日志续传到中央存储系统上

11.设计实时排名的系统
- 可以通过redis的有序集合来实现

12.如果有人恶意攻击网站，发送大量请求怎么办
(1)ddos攻击
- 对目标网站在较短的时间内发起大量请求，大规模消耗目标网站的主机资源，让它无法正常服务
(2)应对方法
- 添加服务器黑名单，禁止攻击者访问
- 对用户请求数据进行实时监控，及时发现DOS攻击等异常流量（比如空请求？），在不影响正常业务开展的情况下清洗掉这些异常流量
- CDN加速：CDN 服务将网站访问流量分配到了各个节点中，这样一方面隐藏网站的真实 IP，另一方面即使遭遇 DDoS 攻击，也可以将流量分散到各个节点中，防止源站崩溃

13.设计一个微信发红包的api，不能有人领到的红包里面没钱，红包数值精确到分
- 传入参数有总钱数，分的份数，随机分还是等分
- 先判断钱数能不能分那么多份，要求总钱数>=0.01*份数
- 根据分发策略，选择随机还是等分
    \*随机：1到总钱数-（总份数-1）*0.01 的随机数（总钱数以分为单位）
    \*等分：判断能不能除开，有余数就将余数加到最后一份里面

14.设计连接池

- 限制连接池中最多、可以容纳的连接数目，避免过度消耗系统资源。
- 当客户请求连接，而连接池中所有连接都已被占用时，该如何处理呢？一种方式是让客户一直等待，直到有空闲连接，另一种方式是为客户分配一个新的临时连接。
- 当客户不再使用连接，需要把连接重新放回连接池。
- 连接池中允许处于空闲状态的连接的最大项目。假定允许的最长空闲时间为十分钟，并且允许空闲状态的连接最大数目为5，那么当连接池中有n个(n>5)连接处于空闲状态的时间超过十分钟时， 就应该把n-5个连接关闭，并且从连接池中删除， 这样才能更有效的利用系统资源

15.扫码登陆的过程
https://blog.csdn.net/j3T9Z7H/article/details/106009662

16.服务的注册和发现，其实依赖于一个注册中心的概念，会不会出现注册中心挂掉，而导致整个服务不可用，有没有什么好的解决方法呢?

在客户端本地缓存提供服务的服务端ip，不过这个就不能实时更新了